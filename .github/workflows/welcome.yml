name: Guest Welcome Bot

on: 
  issues: 
    types:  [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to test with'
        required: true
        type:  number

jobs:
  generate-prep:
    if: github. event.label.name == 'scheduled' || github.event_name == 'workflow_dispatch'
    runs-on:  ubuntu-latest

    steps: 
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Copilot CLI and SDK
        run: |
          npm install -g @github/copilot
          npm install @github/copilot-sdk

      - name: Get issue data
        id: get-issue
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            let issue;

            if (context.eventName === 'workflow_dispatch') {
              issueNumber = ${{ github. event.inputs.issue_number || 0 }};
              const response = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = response.data;
            } else {
              issue = context.payload. issue;
              issueNumber = issue.number;
            }

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_body', issue.body || '');

      - name: Generate personalized prep
        id: personalize
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          ISSUE_BODY: ${{ steps.get-issue.outputs.issue_body }}
        run: |
          cat << 'SCRIPT' > generate-welcome.mjs
          import { CopilotClient } from '@github/copilot-sdk';
          import { appendFileSync } from 'fs';

          const body = process.env.ISSUE_BODY || '';

          const nameMatch = body. match(/Name\s*\n\s*([^\n]+)/);
          const projectMatch = body.match(/Project Name\s*\n\s*([^\n]+)/);
          const repoMatch = body.match(/Project Repo Link\s*\n\s*([^\n]+)/);
          const descMatch = body. match(/Tell us about yourself\s*\n\s*([\s\S]*?)(?=\n###|\n##|$)/);

          const guestName = nameMatch ? nameMatch[1].trim() : 'Guest';
          const projectName = projectMatch ? projectMatch[1].trim() : 'their project';
          const projectRepo = repoMatch ? repoMatch[1].trim() : '';
          const guestBackground = descMatch ? descMatch[1].trim() : '';

          const prompt = `You are writing on behalf of the Open Source Friday teamâ€”a group of developer advocates at            GitHub who host a weekly livestream featuring open source maintainers. 

          The team's vibe:  
          - Genuinely curious about open source
          - Supportive and encouraging to guests
          - Technically-minded but approachable
          - Excited without being over-the-top

          Guest details:
          - Name: ${guestName}
          - Project: ${projectName}
          - Repo: ${projectRepo}
          - About them: ${guestBackground}
          
          Write a 2-3 sentence welcome message that:
          1. Greets them by name
          2. Shows we actually looked at their project (mention something specific)
          3. Expresses genuine excitement about what they'll share
          
          Sign off as "The Open Source Friday Team" but don't include a formal greeting like "Dear" or "Hi". 
          
          Keep it natural and conversational. No emojis.  No markdown. Plain text only.`;

          let personalizedMessage = '';
          let client;

          try {
            client = new CopilotClient();
            await client.start();

            const session = await client.createSession({ model: 'gpt-5' });
            const response = await session.sendAndWait({ prompt });

            if (response?.data?. content) {
              personalizedMessage = response.data.content;
            } else {
              throw new Error('No response content received');
            }

            await session.destroy();

          } catch (error) {
            console.error('Copilot SDK error:', error. message);
            personalizedMessage = `We are thrilled to have ${guestName} joining us to talk about ${projectName}! This is going to be a fantastic session.`;

          } finally {
            if (client) {
              await client.stop().catch(e => console.error('Cleanup error:', e.message));
            }
          }

          const outputFile = process.env.GITHUB_OUTPUT;
          appendFileSync(outputFile, `personalized_message<<EOFMSG\n${personalizedMessage}\nEOFMSG\n`);
          appendFileSync(outputFile, `guest_name=${guestName}\n`);
          SCRIPT

          node generate-welcome.mjs

      - name: Post personalized prep comment
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets. GITHUB_TOKEN }}
          PERSONALIZED_MESSAGE: ${{ steps.personalize.outputs.personalized_message }}
          GUEST_NAME: ${{ steps.personalize.outputs.guest_name }}
          ISSUE_NUMBER: ${{ steps.get-issue.outputs. issue_number }}
        with: 
          script: |
            const personalizedMessage = process.env. PERSONALIZED_MESSAGE;
            const guestName = process.env.GUEST_NAME;
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const repoUrl = context.payload.repository. html_url;
            const guideUrl = repoUrl + '/blob/main/admin/approved-guest.md';

            const comment = [
              '## Welcome to Open Source Friday!  ðŸŽ‰',
              '',
              personalizedMessage,
              '',
              '### Quick Prep Checklist',
              '- Stream starts at **1:00 PM ET** on your scheduled Friday',
              '- Please join at **12:45 PM ET** for tech checks',
              '- Have your demo ready to go (live demos are our audience favorite!)',
              '',
              'For full preparation guidelines and expectations, see our [complete guest guide](' + guideUrl + ').',
              '',
              'Looking forward to your session!'
            ].join('\n');

            await github.rest.issues.createComment({
              issue_number:  issueNumber,
              owner:  context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
