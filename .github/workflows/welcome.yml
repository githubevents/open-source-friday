name: Guest Welcome Bot

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs: 
      issue_number:
        description: 'Issue number to test with'
        required: true
        type: number

jobs:
  generate-prep:
    if: github.event.label.name == 'scheduled' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name:  Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install @github/copilot-sdk puppeteer

      - name: Get issue data
        id: get-issue
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            let issue;
            if (context.eventName === 'workflow_dispatch') {
              issueNumber = ${{ github.event.inputs.issue_number || 0 }};
              const response = await github.rest.issues. get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = response.data;
            } else {
              issue = context.payload.issue;
              issueNumber = issue.number;
            }
            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_body', issue.body || '');
            core.setOutput('issue_url', issue.html_url);

      - name: Parse issue and generate welcome message
        id: personalize
        env:
          GH_TOKEN: ${{ secrets. COPILOT_PAT }}
          ISSUE_BODY:  ${{ steps.get-issue. outputs.issue_body }}
        run: |
          cat > script1.mjs << 'EOF'
          import { appendFileSync } from 'fs';

          const body = process.env. ISSUE_BODY || '';

          const nameMatch = body.match(/### Name\s*\n\s*([^\n]+)/i);
          const handleMatch = body.match(/### GitHub Handle\s*\n\s*@? ([^\n\s]+)/i);
          const projectMatch = body.match(/### Project Name\s*\n\s*([^\n]+)/i);
          const repoMatch = body.match(/### Project Repo Link\s*\n\s*(https:\/\/github\.com\/[^\s]+)/i);
          const descMatch = body.match(/### Tell us about yourself\s*\n\s*([\s\S]*?)(?=\n###|$)/i);

          let guestName = nameMatch ? nameMatch[1].trim() : 'Guest';
          let handle = handleMatch ? handleMatch[1].trim().replace(/^@/, '') : '';
          const projectName = projectMatch ? projectMatch[1].trim() : '';
          const projectRepo = repoMatch ? repoMatch[1].trim() : '';
          const guestBackground = descMatch ?  descMatch[1].trim() : '';

          if (!handle && projectRepo) {
            const repoUserMatch = projectRepo.match(/github\.com\/([^\/]+)/);
            if (repoUserMatch) {
              handle = repoUserMatch[1];
              console.log('Extracted handle from repo URL:', handle);
            }
          }

          console. log('=== PARSED ISSUE DATA ===');
          console. log('Guest Name:', guestName);
          console.log('Handle:', handle);
          console.log('Project:', projectName);
          console.log('Repo:', projectRepo);

          let personalizedMessage = '';

          try {
            const { CopilotClient } = await import('@github/copilot-sdk');
            
            console.log('Initializing Copilot SDK.. .');
            const client = new CopilotClient();
            
            const prompt = `You are writing on behalf of the Open Source Friday team—a group of developer advocates at GitHub who host a weekly livestream featuring open source maintainers. 

          The team's vibe: 
          - Genuinely curious about open source
          - Supportive and encouraging to guests
          - Technically-minded but approachable
          - Excited without being over-the-top

          Guest details: 
          - Name: ${guestName}
          - Project: ${projectName || 'their project'}
          - Repo:  ${projectRepo}
          - About them: ${guestBackground}

          Write a 2-3 sentence welcome message that:
          1. Greets them by name
          2. Shows we actually looked at their project (mention something specific if possible)
          3. Expresses genuine excitement about what they will share

          Sign off as "The Open Source Friday Team" but do not include a formal greeting like "Dear" or "Hi". 

          Keep it natural and conversational.  No emojis. No markdown.  Plain text only.`;

            await client.start();
            console. log('Creating session...');
            const session = await client.createSession({ model: 'gpt-4' });
            
            console.log('Sending prompt to Copilot...');
            const response = await session.sendAndWait({ prompt });

            if (response && response.data && response. data.content) {
              personalizedMessage = response.data.content;
              console.log('Received personalized message from Copilot');
            }

            try { await session.destroy(); } catch (e) { }
            try { await client.stop(); } catch (e) { }
            
          } catch (error) {
            console.error('Copilot SDK error:', error.message);
          }

          if (!personalizedMessage) {
            console.log('Using fallback message');
            if (projectName && guestBackground && guestBackground !== '_No response_') {
              personalizedMessage = guestName + ', we are excited to have you on Open Source Friday! ' + projectName + ' sounds like a fantastic project, and we cannot wait to hear more about your journey building it. Our audience is going to love learning from your experience.\n\nThe Open Source Friday Team';
            } else if (projectName) {
              personalizedMessage = guestName + ', welcome to Open Source Friday! We are thrilled to have you joining us to talk about ' + projectName + '. This is going to be a great session.\n\nThe Open Source Friday Team';
            } else {
              personalizedMessage = guestName + ', welcome to Open Source Friday! We are excited to have you joining us. This is going to be a fantastic session.\n\nThe Open Source Friday Team';
            }
          }

          const outputFile = process.env. GITHUB_OUTPUT;
          appendFileSync(outputFile, 'personalized_message<<EOFMSG\n' + personalizedMessage + '\nEOFMSG\n');
          appendFileSync(outputFile, 'guest_name=' + guestName + '\n');
          appendFileSync(outputFile, 'handle=' + handle + '\n');

