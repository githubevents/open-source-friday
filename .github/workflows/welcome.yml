name: Guest Welcome Bot

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs: 
      issue_number:
        description: 'Issue number to test with'
        required: true
        type: number

jobs:
  generate-prep: 
    if: github.event.label.name == 'scheduled' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name:  Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node. js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install puppeteer

      - name: Get issue data
        id: get-issue
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            let issue;
            if (context.eventName === 'workflow_dispatch') {
              issueNumber = ${{ github.event.inputs.issue_number || 0 }};
              const response = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = response.data;
            } else {
              issue = context.payload.issue;
              issueNumber = issue.number;
            }
            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_body', issue.body || '');
            core.setOutput('issue_url', issue.html_url);

      - name: Parse issue and generate welcome message
        id: personalize
        env:
          ISSUE_BODY: ${{ steps.get-issue.outputs.issue_body }}
        run: |
          node --input-type=module << 'EOFSCRIPT'
          import { appendFileSync } from 'fs';

          const body = process.env.ISSUE_BODY || '';

          const nameMatch = body.match(/### Name\s*\n\s*([^\n]+)/i);
          const handleMatch = body.match(/### GitHub Handle\s*\n\s*@? ([^\n\s]+)/i);
          const projectMatch = body.match(/### Project Name\s*\n\s*([^\n]+)/i);
          const repoMatch = body.match(/### Project Repo Link\s*\n\s*(https:\/\/github\.com\/[^\s]+)/i);
          const descMatch = body.match(/### Tell us about yourself\s*\n\s*([\s\S]*?)(?=\n###|$)/i);

          let guestName = nameMatch ? nameMatch[1]. trim() : 'Guest';
          let handle = handleMatch ? handleMatch[1]. trim().replace(/^@/, '') : '';
          const projectName = projectMatch ? projectMatch[1].trim() : '';
          const projectRepo = repoMatch ? repoMatch[1].trim() : '';
          const guestBackground = descMatch ? descMatch[1].trim() : '';

          // If no handle found, try to extract from repo URL
          if (!handle && projectRepo) {
            const repoUserMatch = projectRepo.match(/github\.com\/([^\/]+)/);
            if (repoUserMatch) {
              handle = repoUserMatch[1];
              console.log('Extracted handle from repo URL:', handle);
            }
          }

          console.log('=== PARSED ISSUE DATA ===');
          console.log('Guest Name:', guestName);
          console.log('Handle:', handle);
          console.log('Project:', projectName);
          console.log('Repo:', projectRepo);

          // Generate a personalized welcome message
          let personalizedMessage = '';
          
          if (projectName && guestBackground && guestBackground !== '_No response_') {
            personalizedMessage = guestName + ', we are excited to have you on Open Source Friday! ' + projectName + ' sounds like a fantastic project, and we cannot wait to hear more about your journey building it. Our audience is going to love learning from your experience.\n\nThe Open Source Friday Team';
          } else if (projectName) {
            personalizedMessage = guestName + ', welcome to Open Source Friday! We are thrilled to have you joining us to talk about ' + projectName + '. This is going to be a great session.\n\nThe Open Source Friday Team';
          } else {
            personalizedMessage = guestName + ', welcome to Open Source Friday! We are excited to have you joining us.  This is going to be a fantastic session.\n\nThe Open Source Friday Team';
          }

          const outputFile = process.env. GITHUB_OUTPUT;
          appendFileSync(outputFile, 'personalized_message<<EOFMSG\n' + personalizedMessage + '\nEOFMSG\n');
          appendFileSync(outputFile, 'guest_name=' + guestName + '\n');
          appendFileSync(outputFile, 'handle=' + handle + '\n');
          appendFileSync(outputFile, 'project_name=' + projectName + '\n');
          appendFileSync(outputFile, 'project_repo=' + projectRepo + '\n');

          console.log('Welcome message generated successfully');
          EOFSCRIPT

      - name: Generate thumbnail
        id: thumbnail
        env:
          GUEST_NAME: ${{ steps.personalize.outputs.guest_name }}
          HANDLE: ${{ steps.personalize.outputs.handle }}
          PROJECT_REPO: ${{ steps.personalize.outputs.project_repo }}
          PROJECT_NAME: ${{ steps.personalize.outputs.project_name }}
        run: |
          node --input-type=module << 'EOFSCRIPT'
          import puppeteer from 'puppeteer';
          import { appendFileSync, writeFileSync } from 'fs';

          const guestName = process.env. GUEST_NAME || 'Guest';
          let handle = process.env.HANDLE || '';
          const projectRepo = process.env.PROJECT_REPO || '';
          const projectName = process.env.PROJECT_NAME || '';

          // If no handle provided, try to extract username from repo URL
          if (!handle && projectRepo) {
            const repoMatch = projectRepo.match(/github\. com\/([^\/]+)/);
            if (repoMatch) {
              handle = repoMatch[1];
              console.log('Extracted handle from repo URL:', handle);
            }
          }

          // If still no handle, we cannot generate a thumbnail
          if (!handle) {
            console.log('No GitHub handle available - skipping thumbnail generation');
            appendFileSync(process.env. GITHUB_OUTPUT, 'thumbnail_generated=false\n');
            process.exit(0);
          }

          console.log('=== THUMBNAIL GENERATION ===');
          console.log('Guest:', guestName);
          console. log('Handle:', handle);
          console.log('Project:', projectName);
          console.log('Repo:', projectRepo);

          const browser = await puppeteer.launch({
            headless: true,
            args: [
              '--no-sandbox',
              '--disable-setuid-sandbox',
              '--disable-dev-shm-usage'
            ]
          });

          try {
            const page = await browser.newPage();
            await page.setViewport({ width: 1400, height: 900 });

            // Listen for errors from the page
            page.on('console', msg => {
              if (msg. type() === 'error') {
                console.log('PAGE ERROR:', msg.text());
              }
            });

            console.log('Loading thumbnail generator...');
            await page.goto('https://andreagriffiths11.github.io/thumbnail-gen/', {
              waitUntil:  'networkidle0',
              timeout: 60000
            });

            console.log('Page loaded successfully');

            // Fill guest name
            console.log('Filling guest name:', guestName);
            await page.evaluate(() => document.getElementById('guestName').value = '');
            await page.type('#guestName', guestName);

            // Fill GitHub username (required!)
            console.log('Filling username:', handle);
            await page. evaluate(() => document.getElementById('username').value = '');
            await page.type('#username', handle);

            // Fill repo URL
            if (projectRepo) {
              console.log('Filling repo:', projectRepo);
              await page. evaluate(() => document.getElementById('repo').value = '');
              await page.type('#repo', projectRepo);
            }

            // Fill project name override if provided
            if (projectName) {
              const hasProjectName = await page.$('#projectName');
              if (hasProjectName) {
                console.log('Filling project name:', projectName);
                await page. evaluate(() => document.getElementById('projectName').value = '');
                await page.type('#projectName', projectName);
              }
            }

            console.log('Clicking generate button...');
            await page.click('#generateBtn');

            // Wait for generation with status checks
            console.log('Waiting for thumbnail generation...');
            
            let attempts = 0;
            const maxAttempts = 30;
            let isReady = false;

            while (attempts < maxAttempts && !isReady) {
              await new Promise(resolve => setTimeout(resolve, 2000));
              
              const status = await page.evaluate(() => {
                const downloadBtn = document.getElementById('downloadBtn');
                const banner = document.getElementById('banner');
                return {
                  downloadDisabled: downloadBtn ?  downloadBtn.disabled : true,
                  bannerText: banner ? banner.textContent :  '',
                  bannerClass: banner ? banner.className : ''
                };
              });

              console.log('Attempt ' + (attempts + 1) + '/' + maxAttempts + ':  Download disabled=' + status.downloadDisabled + ', Banner="' + status.bannerText + '"');

              if (! status.downloadDisabled) {
                isReady = true;
                console.log('Thumbnail generation complete!');
              } else if (status.bannerClass. includes('error')) {
                throw new Error('Thumbnail generation failed:  ' + status.bannerText);
              }

              attempts++;
            }

            if (!isReady) {
              throw new Error('Thumbnail generation timed out');
            }

            // Wait a bit for canvas to fully render
            await new Promise(resolve => setTimeout(resolve, 1000));

            console.log('Extracting canvas data...');
            const thumbnailData = await page.evaluate(() => {
              const canvas = document.getElementById('preview');
              return canvas.toDataURL('image/png');
            });

            const base64Data = thumbnailData.replace(/^data:image\/png;base64,/, '');
            writeFileSync('thumbnail.png', Buffer.from(base64Data, 'base64'));

            console. log('Thumbnail saved successfully!');
            appendFileSync(process.env. GITHUB_OUTPUT, 'thumbnail_generated=true\n');

          } catch (error) {
            console.error('Error generating thumbnail:', error. message);
            appendFileSync(process.env.GITHUB_OUTPUT, 'thumbnail_generated=false\n');
          } finally {
            await browser. close();
          }
          EOFSCRIPT

      - name: Upload thumbnail artifact
        if:  steps.thumbnail. outputs.thumbnail_generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name:  thumbnail-issue-${{ steps. get-issue.outputs.issue_number }}
          path: thumbnail. png
          retention-days: 90

      - name: Post welcome comment
        uses: actions/github-script@v7
        env:
          PERSONALIZED_MESSAGE: ${{ steps. personalize.outputs.personalized_message }}
          GUEST_NAME: ${{ steps.personalize.outputs.guest_name }}
          HANDLE: ${{ steps.personalize.outputs. handle }}
          ISSUE_NUMBER: ${{ steps. get-issue.outputs.issue_number }}
          THUMBNAIL_GENERATED: ${{ steps. thumbnail.outputs.thumbnail_generated }}
          RUN_ID: ${{ github.run_id }}
        with:
          script: |
            const personalizedMessage = process.env. PERSONALIZED_MESSAGE;
            const guestName = process.env.GUEST_NAME;
            const handle = process.env.HANDLE;
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const thumbnailGenerated = process.env.THUMBNAIL_GENERATED === 'true';
            const runId = process.env.RUN_ID;
            const repoUrl = 'https://github.com/' + context.repo.owner + '/' + context.repo.repo;
            const guideUrl = repoUrl + '/blob/main/admin/approved-guest. md';
            const thumbnailToolUrl = 'https://andreagriffiths11.github.io/thumbnail-gen/';
            const artifactUrl = repoUrl + '/actions/runs/' + runId;

            const mention = handle ? '@' + handle : guestName;

            let commentParts = [
              '## Welcome to Open Source Friday!  üéâ',
              '',
              personalizedMessage,
              '',
              '---',
              ''
            ];

            if (thumbnailGenerated) {
              commentParts = commentParts.concat([
                '### üñºÔ∏è Your Promotional Thumbnail',
                '',
                '‚úÖ Your custom thumbnail has been generated! ',
                '',
                '**To download it:**',
                '1. [Click here to view the workflow run](' + artifactUrl + ')',
                '2. Scroll down to **Artifacts**',
                '3. Download `thumbnail-issue-' + issueNumber + '`',
                '',
                'Use this thumbnail to promote your upcoming stream on social media!',
                '',
                '> üí° Want to customize it?  Use our [thumbnail generator](' + thumbnailToolUrl + ').',
                '',
                '---',
                ''
              ]);
            } else {
              commentParts = commentParts.concat([
                '### üñºÔ∏è Create Your Promotional Thumbnail',
                '',
                'Generate a custom thumbnail for your stream using our [thumbnail generator](' + thumbnailToolUrl + ').',
                '',
                '---',
                ''
              ]);
            }

            commentParts = commentParts.concat([
              '### ‚úÖ Quick Prep Checklist',
              '',
              '- [ ] Stream starts at **1:00 PM ET** on your scheduled Friday',
              '- [ ] Please join at **12:45 PM ET** for prep and tech checks',
              '- [ ] Have your demo ready (live demos are our audience favorite!)',
              '- [ ] Share your thumbnail on social media to promote the stream',
              '',
              'üìñ For full preparation guidelines, see our [complete guest guide](' + guideUrl + ').',
              '',
              'Looking forward to your session, ' + mention + '!',
              '',
              '‚Äî The Open Source Friday Team'
            ]);

            const comment = commentParts.join('\n');

            await github.rest.issues. createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

            console.log('Comment posted successfully!');
