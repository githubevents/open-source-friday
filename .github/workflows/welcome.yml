name: Personalized Guest Prep

on:
  issues:
    types: [labeled]

jobs: 
  generate-prep:
    if: github. event.label.name == 'scheduled'
    runs-on:  ubuntu-latest
    
    steps: 
      - name:  Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version:  '22'

      - name: Install Copilot CLI and SDK
        run: |
          npm install -g @github/copilot
          npm install @github/copilot-sdk

      - name:  Generate personalized prep
        id:  personalize
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets. COPILOT_PAT }}  # PAT with Copilot permissions
        with:
          script: |
            const { CopilotClient } = require('@github/copilot-sdk');
            
            const issue = context.payload. issue;
            const body = issue.body || '';
            
            const nameMatch = body.match(/Name\s*\n\s*([^\n]+)/);
            const projectMatch = body.match(/Project Name\s*\n\s*([^\n]+)/);
            const repoMatch = body. match(/Project Repo Link\s*\n\s*([^\n]+)/);
            const descMatch = body.match(/Tell us about yourself\s*\n\s*([\s\S]*?)(?=\n###|\n##|$)/);
            
            const guestName = nameMatch ?  nameMatch[1]. trim() : 'Guest';
            const projectName = projectMatch ?  projectMatch[1].trim() : 'their project';
            const projectRepo = repoMatch ? repoMatch[1].trim() : '';
            const guestBackground = descMatch ? descMatch[1]. trim() : '';
            
            const prompt = `You are a helpful stream coordinator for Open Source Friday. Create a 2-3 sentence personalized welcome message for this guest: 

Guest Name: ${guestName}
Project:  ${projectName}
Project Repo: ${projectRepo}
Guest Background: ${guestBackground}

Write a warm, encouraging message that acknowledges their specific project and shows genuine excitement to have them on the stream.  Keep it concise and authentic. Do not use markdown formatting or special characters. `;
            
            let personalizedMessage = '';
            let client;
            
            try {
              client = new CopilotClient();
              await client.start();
              
              const session = await client.createSession({ model: 'gpt-5' });
              const response = await session.sendAndWait({ prompt });
              
              if (response?. data?.content) {
                personalizedMessage = response.data.content;
              } else {
                throw new Error('No response content received');
              }
              
              await session.destroy();
              
            } catch (error) {
              console.log(`Copilot SDK error: ${error.message}`);
              personalizedMessage = `We're thrilled to have ${guestName} joining us to talk about ${projectName}!  This is going to be a fantastic session. `;
              
            } finally {
              if (client) {
                await client.stop().catch(e => console.log('Cleanup error:', e.message));
              }
            }
            
            core.setOutput('personalized_message', personalizedMessage);
            core.setOutput('guest_name', guestName);

      - name: Post personalized prep comment
        uses: actions/github-script@v7
        env: 
          GITHUB_TOKEN: ${{ secrets. GITHUB_TOKEN }}
          PERSONALIZED_MESSAGE: ${{ steps.personalize.outputs.personalized_message }}
          GUEST_NAME: ${{ steps.personalize.outputs.guest_name }}
        with:
          script: |
            const personalizedMessage = process.env.PERSONALIZED_MESSAGE;
            const guestName = process.env.GUEST_NAME;
            const guideUrl = `${context.payload.repository.html_url}/blob/main/admin/approved-guest.md`;
            
            const comment = `## Welcome to Open Source Friday!  ðŸŽ‰

${personalizedMessage}

### Quick Prep Checklist
- Stream starts at **1:00 PM ET** on your scheduled Friday
- Please join at **12:45 PM ET** for tech checks
- Have your demo ready to go (live demos are our audience's favorite!)

ðŸ“– For full preparation guidelines and expectations, see our [complete guest guide](${guideUrl}).

Looking forward to your session! `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
